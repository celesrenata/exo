# EXO Race Condition Fix Deployment Configuration
# This file contains configuration parameters for deployment and rollback procedures

# Deployment Settings
DEPLOYMENT_TYPE="race-condition-fix"
DEPLOYMENT_VERSION="1.0.0"
DEPLOYMENT_TIMEOUT=300  # 5 minutes

# Backup Settings
BACKUP_RETENTION_DAYS=30
BACKUP_COMPRESSION=true
BACKUP_VERIFICATION=true

# Service Settings
SERVICE_NAME="exo"
SERVICE_STOP_TIMEOUT=30
SERVICE_START_TIMEOUT=60
SERVICE_RESTART_DELAY=10

# Validation Settings
VALIDATION_TIMEOUT=120  # 2 minutes
HEALTH_CHECK_RETRIES=10
HEALTH_CHECK_INTERVAL=5

# Shutdown Coordination Settings
SHUTDOWN_TIMEOUT=30
RESOURCE_CLEANUP_TIMEOUT=10
CHANNEL_DRAIN_TIMEOUT=5

# Monitoring Settings
LOG_RETENTION_HOURS=168  # 1 week
ERROR_THRESHOLD=5  # Maximum errors per hour before alert
MEMORY_THRESHOLD=80  # Memory usage percentage threshold
CPU_THRESHOLD=90   # CPU usage percentage threshold

# Network Settings
API_PORT=52415
HEALTH_ENDPOINT="/health"
STATE_ENDPOINT="/state"
DASHBOARD_ENDPOINT="/"

# File Paths
PROJECT_ROOT="/opt/exo"
BACKUP_DIR="${PROJECT_ROOT}/deployment/backups"
LOG_DIR="${PROJECT_ROOT}/deployment/logs"
CONFIG_DIR="${PROJECT_ROOT}/deployment/config"

# System Settings
PYTHON_VERSION="3.13"
REQUIRED_MEMORY_GB=8
REQUIRED_DISK_GB=10

# Security Settings
SERVICE_USER="exo"
SERVICE_GROUP="exo"
FILE_PERMISSIONS=640
DIR_PERMISSIONS=750

# Environment Variables for Race Condition Fixes
export EXO_SHUTDOWN_TIMEOUT=${SHUTDOWN_TIMEOUT}
export EXO_RESOURCE_CLEANUP_TIMEOUT=${RESOURCE_CLEANUP_TIMEOUT}
export EXO_CHANNEL_DRAIN_TIMEOUT=${CHANNEL_DRAIN_TIMEOUT}
export EXO_DEBUG_COORDINATION=false

# Rollback Settings
ROLLBACK_TIMEOUT=180  # 3 minutes
ROLLBACK_VALIDATION_TIMEOUT=60
AUTO_ROLLBACK_ON_FAILURE=true

# Notification Settings (optional)
NOTIFY_ON_SUCCESS=false
NOTIFY_ON_FAILURE=true
NOTIFICATION_EMAIL=""
SLACK_WEBHOOK=""

# Development/Testing Settings
SKIP_TESTS=false
SKIP_VALIDATION=false
DRY_RUN=false
VERBOSE_LOGGING=true

# Platform-specific Settings
case "$(uname -s)" in
    Linux*)
        PLATFORM="linux"
        SYSTEMCTL_AVAILABLE=true
        JOURNALCTL_AVAILABLE=true
        ;;
    Darwin*)
        PLATFORM="macos"
        SYSTEMCTL_AVAILABLE=false
        JOURNALCTL_AVAILABLE=false
        ;;
    *)
        PLATFORM="unknown"
        SYSTEMCTL_AVAILABLE=false
        JOURNALCTL_AVAILABLE=false
        ;;
esac

# Load local overrides if they exist
if [[ -f "${CONFIG_DIR}/local.conf" ]]; then
    source "${CONFIG_DIR}/local.conf"
fi